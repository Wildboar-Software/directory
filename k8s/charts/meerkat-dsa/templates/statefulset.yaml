apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "meerkat-dsa.fullname" . }}
  labels:
    {{- include "meerkat-dsa.labels" . | nindent 4 }}
spec:
  serviceName: "{{ include "meerkat-dsa.fullname" . }}-directory-headless"
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      {{- include "meerkat-dsa.selectorLabels" . | nindent 6 }}
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        # ReadWriteOncePod is not used, because there is a legitimate use case
        # in using another pod containing a SQLite CLI to inspect your database
        # or even seed it with data.
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: {{ .Values.persistence.size | quote }}
        # Uses the default storageclass otherwise
        {{- if .Values.persistence.storageClass }}
        storageClassName: {{ .Values.persistence.storageClass }}
        {{- end }}
  template:
    metadata:
      labels:
        {{- include "meerkat-dsa.selectorLabels" . | nindent 8 }}
    spec:
      initContainers:
        - name: {{ .Chart.Name }}-init
          image: "{{ .Values.image.repository }}:{{ .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: DATABASE_URL
              value: file:/var/lib/meerkat/meerkat.db
          volumeMounts:
            - name: data
              mountPath: /var/lib/meerkat
              {{- if .Values.persistence.subPath }}
              subPath: {{ .Values.persistence.subPath }}
              {{- end }}
          command:
          - npx
          - prisma
          - migrate
          {{- if .Values.resetDatabase  }}
          - reset
          - --force
          - --skip-generate
          {{- else }}
          - deploy
          {{- end }}
          - --schema=/srv/meerkat/prisma/schema.prisma
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.image.repository }}:{{ .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: DATABASE_URL
              value: file:/var/lib/meerkat/meerkat.db
            {{- if .Values.prismaDebug }}
            - name: DEBUG
              value: {{ .Values.prismaDebug }}
            {{- end }}
            # NOTE: The following port configurations do not override the port
            # that the user specified. These are internal ports. The ports
            # specified in `values.yaml` control the ports on which the
            # service will listen.
            {{- if .Values.web_admin_port }}
            - name: MEERKAT_WEB_ADMIN_PORT
              value: "18080"
            {{- end }}
            {{- if .Values.idm_port }}
            - name: MEERKAT_IDM_PORT
              value: "4632"
            {{- end }}
            {{- if .Values.idms_port }}
            - name: MEERKAT_IDMS_PORT
              value: "44632"
            {{- end }}
            {{- if .Values.ldap_port }}
            - name: MEERKAT_LDAP_PORT
              value: "1389"
            {{- end }}
            {{- if .Values.ldaps_port }}
            - name: MEERKAT_LDAPS_PORT
              value: "1636"
            {{- end }}
            # These environment variables came from the `env.md` documentation,
            - name: NODE_ENV
              value: production
            - name: LC_ALL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: locale
                  optional: true
            - name: LANG
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: locale
                  optional: true
            {{- if .Values.init }}
            - name: MEERKAT_INIT_JS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: /data/init/init.mjs
                  optional: true
            {{- end }}
            # These are created by the Helm chart if you do not provide a signing secret
            - name: MEERKAT_SIGNING_CERTS_CHAIN_FILE
              value: /data/pki/signing/tls.crt
            - name: MEERKAT_SIGNING_KEY_FILE
              value: /data/pki/signing/tls.key
            {{- if .Values.tlsSecretName }}
            - name: MEERKAT_TLS_CERT_FILE
              value: /data/pki/tls/tls.crt
            - name: MEERKAT_TLS_KEY_FILE
              value: /data/pki/tls/tls.key
            {{- end }}
            {{- if .Values.dhParamSecretName }}
            - name: MEERKAT_TLS_DH_PARAM_FILE
              value: /data/dhparam/dhparam.pem
            {{- end }}
            - name: MEERKAT_TLS_ENABLE_TRACE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_enable_trace
                  optional: true
            {{- if .Values.tlsCaConfigName }}
            - name: MEERKAT_TLS_CA_FILE
              value: /data/ca/ca.pem
            {{- end }}
            {{- if .Values.tlsCrlConfigName }}
            - name: MEERKAT_TLS_CRL_FILE
              value: /data/crl/crl.pem
            {{- end }}
            {{- if .Values.attributeCertificationPathConfigName }}
            - name: MEERKAT_ATTR_CERT_CHAIN_FILE
              value: /data/acert/acert.pem
            {{- end }}
            - name: MEERKAT_ADMINISTRATOR_EMAIL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: administrator_email
                  optional: true
            - name: MEERKAT_ADMINISTRATOR_EMAIL_PUBLIC
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: administrator_email_public
                  optional: true
            - name: MEERKAT_ATTR_CERT_DURATION
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: attr_cert_duration
                  optional: true
            - name: MEERKAT_BIND_MIN_SLEEP_MS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: bind_min_sleep_ms
                  optional: true
            - name: MEERKAT_BIND_SLEEP_RANGE_MS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: bind_sleep_range_ms
                  optional: true
            - name: MEERKAT_BULK_INSERT_MODE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: bulk_insert_mode
                  optional: true
            - name: MEERKAT_CLIENT_CERT_ENGINE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: client_cert_engine
                  optional: true
            - name: MEERKAT_CHAINING_CHECK_SIG
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: chaining_check_sig
                  optional: true
            - name: MEERKAT_CHAINING_SIGN_REQUESTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: chaining_sign_requests
                  optional: true
            - name: MEERKAT_CHAINING_TLS_OPTIONAL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: chaining_tls_optional
                  optional: true
            {{- if .Values.clearance_authorities }}
            - name: MEERKAT_CLEARANCE_AUTHORITIES
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: clearance_authorities
                  optional: true
            {{- end }}
            - name: MEERKAT_DEFAULT_ENTRY_TTL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: default_entry_ttl
                  optional: true
            - name: MEERKAT_ENABLE_DISP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: enable_disp
                  optional: true
            - name: MEERKAT_ENABLE_DOP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: enable_dop
                  optional: true
            - name: MEERKAT_ENABLE_DSP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: enable_dsp
                  optional: true
            - name: MEERKAT_ECDH_CURVES
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: ecdh_curves
                  optional: true
            - name: MEERKAT_ENABLE_DAP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: enable_dap
                  optional: true
            - name: MEERKAT_ENTRIES_PER_SUBORDINATES_PAGE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: entries_per_subordinates_page
                  optional: true
            - name: MEERKAT_FORBID_ANONYMOUS_BIND
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: forbid_anonymous_bind
                  optional: true
            - name: MEERKAT_GET_CLEARANCES_FROM_ATTR_CERTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: get_clearances_from_attr_certs
                  optional: true
            - name: MEERKAT_GET_CLEARANCES_FROM_DSAIT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: get_clearances_from_dsait
                  optional: true
            - name: MEERKAT_GET_CLEARANCES_FROM_PKC
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: get_clearances_from_pkc
                  optional: true
            - name: MEERKAT_HONOR_CIPHER_ORDER
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: honor_cipher_order
                  optional: true
            - name: MEERKAT_IDM_BUFFER_SIZE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: idm_buffer_size
                  optional: true
            - name: MEERKAT_ITOT_PORT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: itot_port
                  optional: true
            - name: MEERKAT_ITOTS_PORT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: itots_port
                  optional: true
            - name: MEERKAT_ITOT_ABORT_TIMEOUT_IN_SECONDS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: itot_abort_timeout_in_seconds
                  optional: true
            - name: MEERKAT_ITOT_MAX_NSDU_SIZE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: itot_max_nsdu_size
                  optional: true
            - name: MEERKAT_ITOT_MAX_TPDU_SIZE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: itot_max_tpdu_size
                  optional: true
            - name: MEERKAT_ITOT_MAX_TSDU_SIZE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: itot_max_tsdu_size
                  optional: true
            - name: MEERKAT_ITOT_MAX_SSDU_SIZE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: itot_max_ssdu_size
                  optional: true
            - name: MEERKAT_ITOT_MAX_PRESENTATION_CONTEXTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: itot_max_presentation_contexts
                  optional: true
            - name: MEERKAT_ITOT_ACSE_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: itot_acse_password
                  optional: true
            - name: MEERKAT_DISABLE_ITOT_CHAINING
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: disable_itot_chaining
                  optional: true
            {{- if .Values.labelling_authorities }}
            - name: MEERKAT_LABELLING_AUTHORITIES
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: labelling_authorities
                  optional: true
            {{- end }}
            - name: MEERKAT_LCR_PARALLELISM
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: lcr_parallelism
                  optional: true
            - name: MEERKAT_LDAP_BUFFER_SIZE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: ldap_buffer_size
                  optional: true
            - name: MEERKAT_LOCAL_QUALIFIER_POINTS_FOR_USING_SSL3
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: local_qualifier_points_for_using_ssl3
                  optional: true
            - name: MEERKAT_LOCAL_QUALIFIER_POINTS_FOR_USING_STARTTLS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: local_qualifier_points_for_using_starttls
                  optional: true
            - name: MEERKAT_LOCAL_QUALIFIER_POINTS_FOR_USING_TLS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: local_qualifier_points_for_using_tls
                  optional: true
            - name: MEERKAT_LOCAL_QUALIFIER_POINTS_FOR_USING_TLS_1_0
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: local_qualifier_points_for_using_tls_1_0
                  optional: true
            - name: MEERKAT_LOCAL_QUALIFIER_POINTS_FOR_USING_TLS_1_1
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: local_qualifier_points_for_using_tls_1_1
                  optional: true
            - name: MEERKAT_LOCAL_QUALIFIER_POINTS_FOR_USING_TLS_1_2
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: local_qualifier_points_for_using_tls_1_2
                  optional: true
            - name: MEERKAT_LOCAL_QUALIFIER_POINTS_FOR_USING_TLS_1_3
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: local_qualifier_points_for_using_tls_1_3
                  optional: true
            - name: MEERKAT_LOG_BOUND_DN
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: log_bound_dn
                  optional: true
            - name: MEERKAT_LOG_JSON
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: log_json
                  optional: true
            - name: MEERKAT_LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: log_level
                  optional: true
            - name: MEERKAT_LOG_TLS_SECRETS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: log_tls_secrets
                  optional: true
            - name: MEERKAT_LOOKUP_UNCERT_STRONG_AUTH
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: lookup_uncert_strong_auth
                  optional: true
            - name: MEERKAT_MAX_CONCURRENT_OPERATIONS_PER_CONNECTION
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: max_concurrent_operations_per_connection
                  optional: true
            - name: MEERKAT_MAX_CONNECTIONS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: max_connections
                  optional: true
            - name: MEERKAT_MAX_CONNECTIONS_PER_ADDRESS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: max_connections_per_address
                  optional: true
            - name: MEERKAT_MAX_IDM_PDU_SIZE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: max_idm_pdu_size
                  optional: true
            - name: MEERKAT_MAX_IDM_SEGMENTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: max_idm_segments
                  optional: true
            - name: MEERKAT_MAX_PRE_BIND_REQUESTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: max_pre_bind_requests
                  optional: true
            - name: MEERKAT_MAX_RELAXATIONS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: max_relaxations
                  optional: true
            - name: MEERKAT_MIN_AUTH_LEVEL_FOR_CHAINING
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: min_auth_level_for_chaining
                  optional: true
            - name: MEERKAT_MIN_AUTH_LEVEL_FOR_DISP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: min_auth_level_for_disp
                  optional: true
            - name: MEERKAT_MIN_AUTH_LEVEL_FOR_OB
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: min_auth_level_for_ob
                  optional: true
            - name: MEERKAT_MIN_AUTH_LOCAL_QUALIFIER_FOR_CHAINING
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: min_auth_local_qualifier_for_chaining
                  optional: true
            - name: MEERKAT_MIN_AUTH_LOCAL_QUALIFIER_FOR_DISP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: min_auth_local_qualifier_for_disp
                  optional: true
            - name: MEERKAT_MIN_AUTH_LOCAL_QUALIFIER_FOR_OB
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: min_auth_local_qualifier_for_ob
                  optional: true
            - name: MEERKAT_MIN_TRANSFER_SPEED_BYTES_PER_MINUTE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: min_transfer_speed_bytes_per_minute
                  optional: true
            - name: MEERKAT_MRU_VERTEX_TTL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: mru_vertex_ttl
                  optional: true
            - name: MEERKAT_MY_ACCESS_POINT_NSAPS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: my_access_point_nsaps
                  optional: true
            - name: MEERKAT_NO_COLOR
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: no_color
                  optional: true
            - name: MEERKAT_NO_CONSOLE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: no_console
                  optional: true
            - name: MEERKAT_NO_TIMESTAMP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: no_timestamp
                  optional: true
            - name: MEERKAT_OB_AUTO_ACCEPT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: ob_auto_accept
                  optional: true
            - name: MEERKAT_OPEN_TOP_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: open_top_level
                  optional: true
            - name: MEERKAT_PRINCIPLED_SERVICE_ADMIN
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: principled_service_admin
                  optional: true
            - name: MEERKAT_PRIVATE_KEY_ENGINE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: private_key_engine
                  optional: true
            - name: MEERKAT_PROHIBIT_CHAINING
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: prohibit_chaining
                  optional: true
            - name: MEERKAT_REMOTE_PWD_TIME_LIMIT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: remote_pwd_time_limit
                  optional: true
            {{- if gt (int .Values.replicas) 1 }}
            - name: MEERKAT_REPLICATE_EVERYTHING_FROM
              value: statefulset+idm://{{ include "meerkat-dsa.fullname" . }}-directory-headless.{{ .Release.Namespace }}.svc:4632
            {{- else }}
            - name: MEERKAT_REPLICATE_EVERYTHING_FROM
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: replicate_everything_from
                  optional: true
            {{- end }}
            - name: MEERKAT_REQUEST_CROSS_REFERENCES
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: request_cross_references
                  optional: true
            - name: MEERKAT_RETURN_CROSS_REFERENCES
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: return_cross_references
                  optional: true
            - name: MEERKAT_REVEAL_USER_PWD
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: reveal_user_pwd
                  optional: true
            - name: MEERKAT_SCR_PARALLELISM
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scr_parallelism
                  optional: true
            - name: MEERKAT_SCVP_ATTR_CERT_CHECKS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_attr_cert_checks
                  optional: true
            - name: MEERKAT_SCVP_ATTR_CERT_WANT_BACKS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_attr_cert_want_backs
                  optional: true
            - name: MEERKAT_SCVP_CACHED_RESPONSE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_cached_response
                  optional: true
            - name: MEERKAT_SCVP_DISCLOSE_AE_TITLE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_disclose_ae_title
                  optional: true
            - name: MEERKAT_SCVP_FULL_REQUEST_IN_RESPONSE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_full_request_in_response
                  optional: true
            - name: MEERKAT_SCVP_HASH_ALGORITHM
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_hash_algorithm
                  optional: true
            - name: MEERKAT_SCVP_INHIBIT_ANY_POLICY
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_inhibit_any_policy
                  optional: true
            - name: MEERKAT_SCVP_INHIBIT_POLICY_MAPPING
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_inhibit_policy_mapping
                  optional: true
            - name: MEERKAT_SCVP_PUBLIC_KEY_CERT_CHECKS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_public_key_cert_checks
                  optional: true
            - name: MEERKAT_SCVP_PUBLIC_KEY_CERT_WANT_BACKS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_public_key_cert_want_backs
                  optional: true
            - name: MEERKAT_SCVP_REQUESTOR_TEXT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_requestor_text
                  optional: true
            - name: MEERKAT_SCVP_REQUIRE_EXPLICIT_POLICY
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_require_explicit_policy
                  optional: true
            - name: MEERKAT_SCVP_RESPONSE_VALIDATION_POLICY_BY_REF
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_response_validation_policy_by_ref
                  optional: true
            - name: MEERKAT_SCVP_SIGNATURE_ALGORITHM
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_signature_algorithm
                  optional: true
            - name: MEERKAT_SCVP_URL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_url
                  optional: true
            - name: MEERKAT_SCVP_VALIDATION_ALGORITHM_ID
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_validation_algorithm_id
                  optional: true
            - name: MEERKAT_SCVP_VALIDATION_POLICY_REF_ID
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: scvp_validation_policy_ref_id
                  optional: true
            - name: MEERKAT_SSLKEYLOG_FILE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: sslkeylog_file
                  optional: true
            - name: MEERKAT_SENTINEL_DOMAIN
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: sentinel_domain
                  optional: true
            - name: MEERKAT_SIGNING_ACCEPTABLE_CERT_POLICIES
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_acceptable_cert_policies
                  optional: true
            - name: MEERKAT_SIGNING_BIND_ACCEPTABLE_CERT_POLICIES
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_acceptable_cert_policies
                  optional: true
            - name: MEERKAT_SIGNING_BIND_CRL_DP_ATTEMPTS_PER_CERT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_crl_dp_attempts_per_cert
                  optional: true
            - name: MEERKAT_SIGNING_BIND_MAX_ENDPOINTS_PER_CRL_DP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_max_endpoints_per_crl_dp
                  optional: true
            - name: MEERKAT_SIGNING_BIND_OCSP_CHECKINESS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_ocsp_checkiness
                  optional: true
            - name: MEERKAT_SIGNING_BIND_OCSP_MAX_REQUESTS_PER_CERT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_ocsp_max_requests_per_cert
                  optional: true
            - name: MEERKAT_SIGNING_BIND_OCSP_SIGN_REQUESTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_ocsp_sign_requests
                  optional: true
            - name: MEERKAT_SIGNING_BIND_OCSP_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_ocsp_timeout
                  optional: true
            - name: MEERKAT_SIGNING_BIND_OCSP_UNKNOWN_IS_FAILURE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_ocsp_unknown_is_failure
                  optional: true
            - name: MEERKAT_SIGNING_BIND_REMOTE_CRL_CACHE_TTL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_remote_crl_cache_ttl
                  optional: true
            - name: MEERKAT_SIGNING_BIND_REMOTE_CRL_CHECKINESS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_remote_crl_checkiness
                  optional: true
            - name: MEERKAT_SIGNING_BIND_REMOTE_CRL_SIZE_LIMIT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_remote_crl_size_limit
                  optional: true
            - name: MEERKAT_SIGNING_BIND_REMOTE_CRL_SUPPORTED_PROTOCOLS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_remote_crl_supported_protocols
                  optional: true
            - name: MEERKAT_SIGNING_BIND_REMOTE_CRL_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_remote_crl_timeout
                  optional: true
            - name: MEERKAT_SIGNING_BIND_TOLERATE_UNAVAILABLE_REMOTE_CRL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_bind_tolerate_unavailable_remote_crl
                  optional: true
            {{- if .Values.signingCaConfigName }}
            - name: MEERKAT_SIGNING_CA_FILE
              value: "/data/pki/signing/ca/ca.pem"
            {{- else if and (gt .Values.replicas 1) (empty .Values.signingCaConfigName) }}
            - name: MEERKAT_SIGNING_CA_FILE
              value: "/data/pki/signing/ca/ca.pem"
            {{- end }}
            {{- if .Values.signingTrustAnchorListConfigName }}
            - name: MEERKAT_TRUST_ANCHORS_FILE
              value: "/data/pki/signing/tal/tal.cmsc"
            {{- end }}
            {{- if .Values.trust_for_ibra }}
            - name: MEERKAT_TRUST_FOR_IBRA
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: trust_for_ibra
                  optional: true
            {{- end }}
            {{- if .Values.signingCrlConfigName }}
            - name: MEERKAT_SIGNING_CRL_FILE
              value: "/data/pki/signing/crl/crl.pem"
            {{- end }}
            - name: MEERKAT_SIGNING_CRL_DP_ATTEMPTS_PER_CERT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_crl_dp_attempts_per_cert
                  optional: true
            - name: MEERKAT_SIGNING_CRL_FILE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_crl_file
                  optional: true
            - name: MEERKAT_SIGNING_DISABLE_VERIFICATION
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_disable_verification
                  optional: true
            - name: MEERKAT_SIGNING_ERRORS_MIN_AUTH_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_errors_min_auth_level
                  optional: true
            - name: MEERKAT_SIGNING_ERRORS_MIN_AUTH_LOCAL_QUALIFIER
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_errors_min_auth_local_qualifier
                  optional: true
            - name: MEERKAT_SIGNING_ERRORS_MIN_AUTH_SIGNED
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_errors_min_auth_signed
                  optional: true
            - name: MEERKAT_SIGNING_MAX_ENDPOINTS_PER_CRL_DP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_max_endpoints_per_crl_dp
                  optional: true
            - name: MEERKAT_SIGNING_MIN_AUTH_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_min_auth_level
                  optional: true
            - name: MEERKAT_SIGNING_MIN_AUTH_LOCAL_QUALIFIER
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_min_auth_local_qualifier
                  optional: true
            - name: MEERKAT_SIGNING_MIN_AUTH_SIGNED
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_min_auth_signed
                  optional: true
            - name: MEERKAT_SIGNING_OCSP_CHECKINESS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_ocsp_checkiness
                  optional: true
            - name: MEERKAT_SIGNING_OCSP_MAX_REQUESTS_PER_CERT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_ocsp_max_requests_per_cert
                  optional: true
            - name: MEERKAT_SIGNING_OCSP_REPLAY_WINDOW
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_ocsp_replay_window
                  optional: true
            - name: MEERKAT_SIGNING_OCSP_RESPONSE_SIZE_LIMIT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_ocsp_response_size_limit
                  optional: true
            - name: MEERKAT_SIGNING_OCSP_SIGN_REQUESTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_ocsp_sign_requests
                  optional: true
            - name: MEERKAT_SIGNING_OCSP_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_ocsp_timeout
                  optional: true
            - name: MEERKAT_SIGNING_OCSP_UNKNOWN_IS_FAILURE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_ocsp_unknown_is_failure
                  optional: true
            - name: MEERKAT_SIGNING_PERMITTED_ALGORITHMS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_permitted_algorithms
                  optional: true
            - name: MEERKAT_SIGNING_REMOTE_CRL_CACHE_TTL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_remote_crl_cache_ttl
                  optional: true
            - name: MEERKAT_SIGNING_REMOTE_CRL_CHECKINESS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_remote_crl_checkiness
                  optional: true
            - name: MEERKAT_SIGNING_REMOTE_CRL_SIZE_LIMIT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_remote_crl_size_limit
                  optional: true
            - name: MEERKAT_SIGNING_REMOTE_CRL_SUPPORTED_PROTOCOLS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_remote_crl_supported_protocols
                  optional: true
            - name: MEERKAT_SIGNING_REMOTE_CRL_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_remote_crl_timeout
                  optional: true
            - name: MEERKAT_SIGNING_REQUIRED_FOR_CHAINING
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_required_for_chaining
                  optional: true
            - name: MEERKAT_SIGNING_REQUIRED_FOR_DISP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_required_for_disp
                  optional: true
            - name: MEERKAT_SIGNING_REQUIRED_FOR_OB
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_required_for_ob
                  optional: true
            - name: MEERKAT_SIGNING_REQUIRED_TO_TRUST_XR
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_required_to_trust_xr
                  optional: true
            - name: MEERKAT_SIGNING_TOLERATE_UNAVAILABLE_REMOTE_CRL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: signing_tolerate_unavailable_remote_crl
                  optional: true
            - name: MEERKAT_TCP_NO_DELAY
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tcp_no_delay
                  optional: true
            - name: MEERKAT_TCP_TIMEOUT_IN_SECONDS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tcp_timeout_in_seconds
                  optional: true
            - name: MEERKAT_TLS_ANSWER_OCSP_REQUESTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_answer_ocsp_requests
                  optional: true
            - name: MEERKAT_TLS_CIPHERS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_ciphers
                  optional: true
            - name: MEERKAT_TLS_CLIENT_CERT_AUTH
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_client_cert_auth
                  optional: true
            - name: MEERKAT_TLS_HANDSHAKE_TIMEOUT_IN_SECONDS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_handshake_timeout_in_seconds
                  optional: true
            - name: MEERKAT_TLS_KEY_PASSPHRASE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_key_passphrase
                  optional: true
            - name: MEERKAT_TLS_MAX_VERSION
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_max_version
                  optional: true
            - name: MEERKAT_TLS_MIN_VERSION
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_min_version
                  optional: true
            - name: MEERKAT_TLS_OCSP_CHECKINESS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_ocsp_checkiness
                  optional: true
            - name: MEERKAT_TLS_OCSP_MAX_REQUESTS_PER_CERT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_ocsp_max_requests_per_cert
                  optional: true
            - name: MEERKAT_TLS_OCSP_REPLAY_WINDOW
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_ocsp_replay_window
                  optional: true
            - name: MEERKAT_TLS_OCSP_RESPONSE_SIZE_LIMIT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_ocsp_response_size_limit
                  optional: true
            - name: MEERKAT_TLS_OCSP_SIGN_REQUESTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_ocsp_sign_requests
                  optional: true
            - name: MEERKAT_TLS_OCSP_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_ocsp_timeout
                  optional: true
            - name: MEERKAT_TLS_OCSP_UNKNOWN_IS_FAILURE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_ocsp_unknown_is_failure
                  optional: true
            - name: MEERKAT_TLS_PFX_FILE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_pfx_file
                  optional: true
            - name: MEERKAT_TLS_REJECT_UNAUTHORIZED_CLIENTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_reject_unauthorized_clients
                  optional: true
            - name: MEERKAT_TLS_REJECT_UNAUTHORIZED_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_reject_unauthorized_servers
                  optional: true
            - name: MEERKAT_TLS_REQUEST_CERT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_request_cert
                  optional: true
            - name: MEERKAT_TLS_REQUEST_OCSP
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_request_ocsp
                  optional: true
            - name: MEERKAT_TLS_SESSION_TIMEOUT_IN_SECONDS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_session_timeout_in_seconds
                  optional: true
            - name: MEERKAT_TLS_SIG_ALGS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: tls_sig_algs
                  optional: true
            - name: MEERKAT_TRANSCODE_DISTINGUISHED_VALUES_TO_DER
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: transcode_distinguished_values_to_der
                  optional: true
            - name: MEERKAT_TRANSCODE_VALUES_TO_DER
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: transcode_values_to_der
                  optional: true
            - name: MEERKAT_TRUST_ANCHORS_FILE
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: trust_anchors_file
                  optional: true
            - name: MEERKAT_USE_DATABASE_WHEN_THERE_ARE_X_SUBORDINATES
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: use_database_when_there_are_x_subordinates
                  optional: true
            - name: MEERKAT_VENDOR_NAME
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: vendor_name
                  optional: true
            - name: MEERKAT_VENDOR_VERSION
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: vendor_version
                  optional: true
            - name: MEERKAT_WEB_ADMIN_AUTH_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: web_admin_auth_username
                  optional: true
            - name: MEERKAT_WEB_ADMIN_AUTH_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: web_admin_auth_password
                  optional: true
            - name: MEERKAT_WEB_ADMIN_AUTH_REALM
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: web_admin_auth_realm
                  optional: true
            - name: MEERKAT_WEB_ADMIN_USE_TLS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "meerkat-dsa.fullname" . }}-config
                  key: web_admin_use_tls
                  optional: true
          ports:
            - name: idm
              containerPort: 4632
              protocol: TCP
            - name: idms
              containerPort: 44632
              protocol: TCP
            {{- if .Values.ldap_port }}
            - name: ldap
              containerPort: 1389
              protocol: TCP
            - name: ldaps
              containerPort: 1636
              protocol: TCP
            {{- end }}
            {{- if .Values.web_admin_port }}
            - name: admin
              containerPort: 18080
              protocol: TCP
            {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          volumeMounts:
            - name: data
              mountPath: /var/lib/meerkat
              {{- if .Values.persistence.subPath }}
              subPath: {{ .Values.persistence.subPath }}
              {{- end }}
            - name: signing-volume
              mountPath: "/data/pki/signing"
              readOnly: true
            {{- if .Values.signingCaConfigName }}
            - name: signing-ca-volume
              mountPath: "/data/pki/signing/ca"
              readOnly: true
            {{- else if gt .Values.replicas 1 }}
            - name: signing-ca-volume
              mountPath: "/data/pki/signing/ca"
              readOnly: true
            {{- end }}
            {{- if .Values.signingTrustAnchorListConfigName }}
            - name: signing-tal-volume
              mountPath: "/data/pki/signing/tal"
              readOnly: true
            {{- end }}
            {{- if .Values.signingCrlConfigName }}
            - name: signing-crl-volume
              mountPath: "/data/pki/signing/crl"
              readOnly: true
            {{- end }}
            {{- if .Values.tlsSecretName }}
            - name: tls-secret-volume
              mountPath: "/data/pki/tls"
              readOnly: true
            {{- end }}
            {{- if .Values.dhParamSecretName }}
            - name: dhparam-secret-volume
              mountPath: "/data/dhparam"
              readOnly: true
            {{- end }}
            {{- if .Values.tlsCaConfigName }}
            - name: ca-volume
              mountPath: "/data/ca"
              readOnly: true
            {{- end }}
            {{- if .Values.tlsCrlConfigName }}
            - name: crl-volume
              mountPath: "/data/crl"
              readOnly: true
            {{- end }}
            {{- if .Values.attributeCertificationPathConfigName }}
            - name: acert-volume
              mountPath: "/data/acert"
              readOnly: true
            {{- end }}
            {{- if .Values.init }}
            - name: init-volume
              mountPath: "/data/init"
              readOnly: true
            {{- end }}
      volumes:
        {{- if not .Values.persistence.enabled }}
        - name: data
          emptyDir: {}
        {{- else if .Values.persistence.existingClaim }}
        - name: data
          persistentVolumeClaim:
            claimName: {{ tpl .Values.persistence.existingClaim . }}
        {{- end }}
        {{- if .Values.signingCaConfigName }}
        - name: signing-ca-volume
          configMap:
            name: {{ .Values.signingCaConfigName | quote }}
        {{- else if gt .Values.replicas 1 }}
        - name: signing-ca-volume
          configMap:
            name: {{ include "meerkat-dsa.fullname" . }}-signing-ca
        {{- end }}
        {{- if .Values.signingTrustAnchorListConfigName }}
        - name: signing-tal-volume
          configMap:
            name: {{ .Values.signingTrustAnchorListConfigName | quote }}
        {{- end }}
        {{- if .Values.signingCrlConfigName }}
        - name: signing-crl-volume
          configMap:
            name: {{ .Values.signingCrlConfigName | quote }}
        {{- end }}
        {{- if .Values.signingSecretName }}
        - name: signing-volume
          secret:
            secretName: {{ .Values.signingSecretName | quote }}
        {{- else }}
        - name: signing-volume
          secret:
            secretName: "{{ include "meerkat-dsa.fullname" . }}-signing"
        {{- end }}
        {{- if .Values.tlsSecretName }}
        - name: tls-secret-volume
          secret:
            secretName: {{ .Values.tlsSecretName | quote }}
        {{- end }}
        {{- if .Values.dhParamSecretName }}
        - name: dhparam-secret-volume
          secret:
            secretName: {{ .Values.dhParamSecretName | quote }}
        {{- end }}
        {{- if .Values.tlsCaConfigName }}
        - name: ca-volume
          configMap:
            name: {{ .Values.tlsCaConfigName | quote }}
        {{- end }}
        {{- if .Values.tlsCrlConfigName }}
        - name: crl-volume
          configMap:
            name: {{ .Values.tlsCrlConfigName | quote }}
        {{- end }}
        {{- if .Values.attributeCertificationPathConfigName }}
        - name: att-cert-volume
          configMap:
            name: {{ .Values.attributeCertificationPathConfigName | quote }}
        {{- end }}
        {{- if .Values.initJsConfigName }}
        - name: init-volume
          configMap:
            name: {{ .Values.initJsConfigName | quote }}
            items:
              - key: init
                path: init.mjs
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
    {{- end }}
    {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
    {{- end }}
