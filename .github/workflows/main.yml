name: Main Workflow

on:
  push:
    tags:
      - v**

env:
  CLUSTER_NAME: meerkat-helm-test
  # RESOURCE_GROUP: production
  RESOURCE_GROUP: meerkat-helm-test
  DNS_RESOURCE_GROUP: production
  NAMESPACE: test
  ZONE: mkdemo.wildboar.software
  STORAGE_ACCOUNT_NAME: meerkatdsahelmtest
  CHART_CONTAINER: asdf
  CHART_REPO: wildboar
  CHART_NAME: meerkat-dsa
  DEMO_TRUST_ANCHOR_CONFIG_NAME: demo-trust-anchor

jobs:

  lint:
    name: Linting
    runs-on: ubuntu-latest
    environment: production
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '17'
      - name: Install NPM Packages
        run: npm ci
      - name: Generate Prisma Client
        run: npx -q prisma generate --schema=apps/meerkat/src/prisma/schema.prisma
      - name: Run Linter
        run: npx nx run-many --target=lint --all --skip-nx-cache
        timeout-minutes: 2
      - name: Lint Helm Charts
        run: helm lint ./k8s/charts/meerkat-dsa/

  # TODO: For now, this job is disabled. For some reason, it just hangs there
  # indefinitely until it times out. This happens locally, so I know it's not
  # just a GitHub Actions problem.
  # unit_testing:
  #   name: Unit Testing
  #   runs-on: ubuntu-latest
  #   environment: production
  #   strategy:
  #     fail-fast: false
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2
  #     - name: Install Node.js
  #       uses: actions/setup-node@v2
  #       with:
  #         node-version: '17'
  #     - name: Install NPM Packages
  #       run: npm ci
  #     - name: Generate Prisma Client
  #       run: npx -q prisma generate --schema=apps/meerkat/src/prisma/schema.prisma
  #     - name: Run Unit Tests
  #       run: npx nx run-many --target=test --all --skip-nx-cache
  #       timeout-minutes: 5

  publish_libs:
    name: Publish Libraries
    runs-on: ubuntu-latest
    environment: production
    strategy:
      fail-fast: false
      matrix:
        library:
          - 'idm'
          - 'ldap-socket'
          - 'meerkat-types'
          - 'x500-cli-config'
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '17'
      - name: Install NPM Packages
        run: npm ci
      - name: Generate Prisma Client
        run: npx -q prisma generate --schema=apps/meerkat/src/prisma/schema.prisma
      - name: Compile ${{ matrix.library }} Library
        run: npx nx run ${{ matrix.library }}:build --skip-nx-cache
        # We use || true here because the version numbers will usually be the
        # same between pipeline runs, so most attempted publishing will fail due
        # to duplicate version numbers.
      - name: Publish NPM Package
        run: npm publish || true
        working-directory: ./dist/libs/${{ matrix.library }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  build:
    name: Build Meerkat DSA
    runs-on: ubuntu-latest
    needs:
      - publish_libs
    environment: production
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Determine Meerkat DSA Version
        run: |
            echo "PUBLISHING_MEERKAT_VERSION=$(cat k8s/charts/meerkat-dsa/Chart.yaml | grep appVersion | sed 's/appVersion: //' | sed 's/\r$//')" >> $GITHUB_ENV
      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '17'
      - name: Install NPM Packages
        run: npm ci
      - name: Generate Prisma Client
        run: npx -q prisma generate --schema=apps/meerkat/src/prisma/schema.prisma
      - name: Compile Meerkat DSA
        run: npx nx run meerkat:build:production --skip-nx-cache
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to the Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ghcr.io/wildboar-software/meerkat-dsa:latest,ghcr.io/wildboar-software/meerkat-dsa:${{ env.PUBLISHING_MEERKAT_VERSION }}
          context: ./
          file: ./meerkat.dockerfile

  # HOW DOES THIS EVEN WORK?
  # There is no point in this job where it installs Helm, but yet, somehow, this
  # job runs the `helm` command successfully!
  helm:
    name: Publish Helm Chart
    runs-on: ubuntu-latest
    environment: production
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Create the Helm Package
        run: helm package .
        working-directory: ./k8s/charts/meerkat-dsa
      - name: Create the Helm Index
        run: helm repo index . --url https://${{ env.STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/${{ env.CHART_CONTAINER }}
        working-directory: ./k8s/charts/meerkat-dsa
      - name: Upload Helm Packages
        uses: bacongobbler/azure-blob-storage-upload@main
        with:
          source_dir: ./k8s/charts/meerkat-dsa
          container_name: ${{ env.CHART_CONTAINER }}
          connection_string: ${{ secrets.AZURE_BLOB_CNXN_STRING }}
          extra_args: '--pattern *.tgz'
          overwrite: 'true'
      - name: Upload Helm Index
        uses: bacongobbler/azure-blob-storage-upload@main
        with:
          source_dir: ./k8s/charts/meerkat-dsa
          container_name: ${{ env.CHART_CONTAINER }}
          connection_string: ${{ secrets.AZURE_BLOB_CNXN_STRING }}
          extra_args: '--pattern index.yaml'
          overwrite: 'true'

  deploy_test:
    name: Deploy Test Environment
    runs-on: ubuntu-latest
    needs:
      - build
      - helm
    environment: production
    strategy:
      fail-fast: false
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Setup Kubectl
        uses: azure/setup-kubectl@v2.0
        # with:
        #   version: 'v1.18.8'
      - name: Setup Helm
        uses: azure/setup-helm@v1
        # with:
        #   version: '<version>' # default is latest stable
        # id: install
      - name: Set Kubernetes Context
        uses: azure/aks-set-context@v1
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'
          cluster-name: ${{ env.CLUSTER_NAME }}
          resource-group: ${{ env.RESOURCE_GROUP }}
      - name: Create Kubernetes Namespace
        run: kubectl create ns ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete Migration Job
        run: kubectl delete job meerkat-dsa-test-migrate -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Uninstall Previous Meerkat DSA Release
        run: helm uninstall meerkat-dsa-test -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Uninstall Previous MySQL Database
        run: helm uninstall meerkat-db-test -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete MySQL Secret
        run: kubectl delete secret mysql-db-test -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete Meerkat Database Secret
        run: kubectl delete secret meerkat-test-db -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete Meerkat Signing Secret
        run: kubectl delete secret meerkat-test-signing -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete Meerkat TLS Secret
        run: kubectl delete secret meerkat-test-tls -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete MySQL Database Data
        run: kubectl delete pvc data-meerkat-db-test-mysql-0 -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete DSA DNS Record
        run: |
          az network dns record-set a delete \
            --resource-group ${{ env.DNS_RESOURCE_GROUP }} \
            --zone-name ${{ env.ZONE }} \
            --name dsa01.test \
            --yes
        continue-on-error: true
      - name: Delete Web Admin DNS Record
        run: |
          az network dns record-set a delete \
            --resource-group ${{ env.DNS_RESOURCE_GROUP }} \
            --zone-name ${{ env.ZONE }} \
            --name webadm01.test \
            --yes
        continue-on-error: true
        # I was having an issue getting a new instance to start. I think the issue
        # is that the password settings for a given chart are only applied the first
        # time it is deployed. When you delete a bitnami/mysql release, it does NOT
        # delete the PVCs it created, which means that the OLD password will
        # persist. Since this script deletes and re-installs under the same name
        # every time, it must necessarily have a deterministic password.
        # See this GitHub issue: https://github.com/bitnami/charts/issues/9083
      - name: Create MySQL Secret
        run: |
          kubectl create secret generic mysql-db-test \
            --from-literal=mysql-root-password=asdf_test \
            --from-literal=mysql-replication-password=asdf_test \
            --from-literal=mysql-password=asdf_test \
            --namespace=${{ env.NAMESPACE }}
      - name: Create Meerkat Database Secret
        run: |
          kubectl create secret generic meerkat-test-db \
            --from-literal=databaseUrl=mysql://root:asdf_test@meerkat-db-test-mysql.${{ env.NAMESPACE }}.svc.cluster.local:3306/directory \
            --namespace=${{ env.NAMESPACE }}
      - name: Create Temp Folder
        run: mkdir -p ./tmp
      - name: Create OpenSSL Keypair
        run: |
          openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes \
            -keyout ./tmp/test.key \
            -out ./tmp/test.crt \
            -subj "/CN=dsa01.test.${{ env.ZONE }}" \
            -addext "subjectAltName=DNS:dsa01.test.${{ env.ZONE }}"
      - name: Create Meerkat Signing Secret
        run: |
          kubectl create secret tls meerkat-test-signing \
            --cert=./tmp/test.crt \
            --key=./tmp/test.key \
            --namespace=${{ env.NAMESPACE }}
      - name: Create Meerkat TLS Secret
        run: |
          kubectl create secret tls meerkat-test-tls \
            --cert=./tmp/test.crt \
            --key=./tmp/test.key \
            --namespace=${{ env.NAMESPACE }}
      - name: Add Bitnami Helm Repo
        run: helm repo add bitnami https://charts.bitnami.com/bitnami
      - name: Add Wildboar Helm Repo
        run: helm repo add ${{ env.CHART_REPO }} https://${{ env.STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/${{ env.CHART_CONTAINER }}
      - name: Update Helm Repo Index
        run: helm repo update
      - name: Install MySQL
        run: |
          helm install meerkat-db-test bitnami/mysql \
            --set auth.existingSecret=mysql-db-test \
            --set auth.database=directory \
            --atomic \
            --namespace=${{ env.NAMESPACE }}
      - name: Deploy Meerkat DSA via Helm
        run: |
          helm install meerkat-dsa-test ${{ env.CHART_REPO }}/${{ env.CHART_NAME }} \
            --set fullnameOverride=meerkat-test \
            --set service.type=LoadBalancer \
            --set adminService.type=LoadBalancer \
            --set log.level=debug \
            --set "myAccessPointNSAPs={idm://dsa01.test.${{ env.ZONE }}:4632,ldap://dsa01.test.${{ env.ZONE }}:389}" \
            --set chaining.minAuthLevel=0 \
            --set chaining.minAuthLocalQualifier=0 \
            --set chaining.tlsOptional=true \
            --set chaining.prohibited=false \
            --set ob.minAuthLevel=0 \
            --set ob.minAuthLocalQualifier=0 \
            --set ob.autoAccept=true \
            --set databaseReset=true \
            --set dangerouslyExposeWebAdmin=true \
            --set databaseSecretName=meerkat-test-db \
            --set signingSecretName=meerkat-test-signing \
            --set tlsSecretName=meerkat-test-tls \
            --set openTopLevel=true \
            --set maxConnections=100 \
            --set maxConnectionsPerAddress=50 \
            --set maxConcurrentOperationsPerConnection=50 \
            --atomic \
            --namespace=${{ env.NAMESPACE }}
      - name: Wait 30 Seconds for Public IP to be Allocated
        run: sleep 30
      - name: Save Directory Service IP Address
        run: |
          echo 'DIRECTORY_SERVICE_IP=$(kubectl get svc -n ${{ env.NAMESPACE }} meerkat-test-directory --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")' >> $GITHUB_ENV
      - name: Save Web Admin Service IP Address
        run: |
          echo 'WEB_ADMIN_SERVICE_IP=$(kubectl get svc -n ${{ env.NAMESPACE }} meerkat-test-web-admin --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")' >> $GITHUB_ENV
      - name: Create DSA DNS Record
        run: |
          az network dns record-set a add-record \
            --resource-group ${{ env.DNS_RESOURCE_GROUP }} \
            --zone-name ${{ env.ZONE }} \
            --ttl 60 \
            --record-set-name dsa01.test \
            --ipv4-address ${{ env.DIRECTORY_SERVICE_IP }}
      - name: Create WebAdmin DNS Record
        run: |
          az network dns record-set a add-record \
            --resource-group ${{ env.DNS_RESOURCE_GROUP }} \
            --zone-name ${{ env.ZONE }} \
            --ttl 60 \
            --record-set-name webadm01.test \
            --ipv4-address ${{ env.WEB_ADMIN_SERVICE_IP }}

  create_demo_pki:
    name: Create Demo PKI
    runs-on: ubuntu-latest
    environment: production
    env:
      CA_CERT: |
        -----BEGIN CERTIFICATE-----
        MIIDbTCCAlWgAwIBAgIULVexlqqnsQ1/ezE1u8+lQW3iC/8wDQYJKoZIhvcNAQEL
        BQAwRjELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkZMMQ4wDAYDVQQHDAVUYW1wYTEa
        MBgGA1UECgwRV2lsZGJvYXIgU29mdHdhcmUwHhcNMjIwNDA2MDAxODA5WhcNNDkw
        ODIyMDAxODA5WjBGMQswCQYDVQQGEwJVUzELMAkGA1UECAwCRkwxDjAMBgNVBAcM
        BVRhbXBhMRowGAYDVQQKDBFXaWxkYm9hciBTb2Z0d2FyZTCCASIwDQYJKoZIhvcN
        AQEBBQADggEPADCCAQoCggEBANfoJHPvPB0PTbywZ/LJwYTN75d2rqaRo/0jf+f2
        uviyVVLIeVMRsImjfhBCK32kDp4EUB3jwhjoMnb0LubuY63o40uCF9STb2pT9b/C
        5QsBdH1UGAgfGykRFkGG8SDAx+prkafiy69ha/ZtLRZW78bfPmGWDq7ALwEMKdvz
        xEF0+B7Nj5hmvVnt51+Tf2nUi8LXLn3uyK8Tu9HkZt3LkQgCAQENOGg97kpXU7aj
        +Ime99pIQr9ehnioCt8tegHXJkQF42Yh6xnlfwqakLMYjPsulfM+1ZF3TGbabHA9
        owt1w0aOtmoicNeLdZ31YSXGrAZTa9U9YlYh1cH0Y7Kr14UCAwEAAaNTMFEwHQYD
        VR0OBBYEFNnD4JAJEcfK/62LwuKq8RQnrTmwMB8GA1UdIwQYMBaAFNnD4JAJEcfK
        /62LwuKq8RQnrTmwMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEB
        AAkWT0CbFTaUttuZJNDYX7vtdId2dS3BF3cPglaXuYag7IZmvMQ/XrOW2Wr3CcKU
        Mg0rbIuCmn37fBFrggDg+NICOcOAuXs9wdufUvAQx9RFc4kv749uTmjWA2H4Oz+R
        S8cyDlwXICD/QaEjo9I306umXZA1bkO8M2jHjIBDslLFsSWwQags08DrWZTwC9tU
        W1rwqkOlabEpphV4snFuuYqyHXTmCVjUQVipPj4mLi9J5ydSyJSnhKy4neoOGYyC
        lfpmMNCkvSpqT3Z2DXoYk38sH8SWfJfcX3ao6InIMq6v12mpnQwhvgTGuAmwDHLz
        4omJCGN3ohmP9kr2tp3Cf6o=
        -----END CERTIFICATE-----
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Setup Kubectl
        uses: azure/setup-kubectl@v2.0
      - name: Setup Helm
        uses: azure/setup-helm@v1
      - name: Set Kubernetes Context
        uses: azure/aks-set-context@v1
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'
          cluster-name: ${{ env.CLUSTER_NAME }}
          resource-group: ${{ env.RESOURCE_GROUP }}
      - name: Create Temp Folder
        run: mkdir -p ./tmp
      - name: Create Certificate Authority Certificate
        run: echo "${{ env.CA_CERT }}" > ca.crt
      - name: Delete Demo Trust Anchor ConfigMap
        run: kubectl delete configmap ${{ env.DEMO_TRUST_ANCHOR_CONFIG_NAME }} -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Create Demo Trust Anchor ConfigMap
        run: |
          kubectl create configmap ${{ env.DEMO_TRUST_ANCHOR_CONFIG_NAME }} \
            --from-file=ca.pem=ca.crt \
            --namespace=${{ env.NAMESPACE }}

  deploy_demo:
    name: Deploy Demo Environment
    runs-on: ubuntu-latest
    needs:
      - build
      - helm
      - create_demo_pki
    environment: production
    env:
      # Credits: https://blogg.bekk.no/how-to-sign-a-certificate-request-with-openssl-e046c933d3ae
      CA_CONFIG: |
        [ ca ]
        default_ca = ca_default
        [ ca_default ]
        certs = .
        new_certs_dir = ./ca.db.certs
        database = ./ca.db.index
        serial = ./ca.db.serial
        RANDFILE = ./ca.db.rand
        certificate = ./ca.crt
        private_key = ./ca.key
        default_days = 730
        default_crl_days = 30
        default_md = md5
        preserve = no
        policy = generic_policy
        [ generic_policy ]
        countryName = optional
        stateOrProvinceName = optional
        localityName = optional
        organizationName = optional
        organizationalUnitName = optional
        commonName = optional
        emailAddress = optional
    strategy:
      fail-fast: false
      matrix:
        dmd:
          - 'root'
          - 'gb'
          # - 'ru'
          # - 'ru-moscow'
    steps:
      # - name: Checkout
      #   uses: actions/checkout@v2
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Setup Kubectl
        uses: azure/setup-kubectl@v2.0
      - name: Setup Helm
        uses: azure/setup-helm@v1
      - name: Set Kubernetes Context
        uses: azure/aks-set-context@v1
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'
          cluster-name: ${{ env.CLUSTER_NAME }}
          resource-group: ${{ env.RESOURCE_GROUP }}
      - name: Create Kubernetes Namespace
        run: kubectl create ns ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete Migration Job
        run: kubectl delete job meerkat-dsa-${{ matrix.dmd }}-migrate -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Uninstall Previous Meerkat DSA Release
        run: helm uninstall meerkat-dsa-${{ matrix.dmd }} -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Uninstall Previous MySQL Database
        run: helm uninstall meerkat-db-${{ matrix.dmd }} -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete MySQL Secret
        run: kubectl delete secret mysql-db-${{ matrix.dmd }} -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete Meerkat Database Secret
        run: kubectl delete secret meerkat-${{ matrix.dmd }}-db -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete Meerkat Signing Secret
        run: kubectl delete secret meerkat-${{ matrix.dmd }}-signing -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete Meerkat TLS Secret
        run: kubectl delete secret meerkat-${{ matrix.dmd }}-tls -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete MySQL Database Data
        run: kubectl delete pvc data-meerkat-db-${{ matrix.dmd }}-mysql-0 -n ${{ env.NAMESPACE }}
        continue-on-error: true
      - name: Delete DSA DNS Record
        run: |
          az network dns record-set a delete \
            --resource-group ${{ env.DNS_RESOURCE_GROUP }} \
            --zone-name ${{ env.ZONE }} \
            --name dsa01.${{ matrix.dmd }} \
            --yes
        continue-on-error: true
      - name: Delete Web Admin DNS Record
        run: |
          az network dns record-set a delete \
            --resource-group ${{ env.DNS_RESOURCE_GROUP }} \
            --zone-name ${{ env.ZONE }} \
            --name webadm01.${{ matrix.dmd }} \
            --yes
        continue-on-error: true
        # I was having an issue getting a new instance to start. I think the issue
        # is that the password settings for a given chart are only applied the first
        # time it is deployed. When you delete a bitnami/mysql release, it does NOT
        # delete the PVCs it created, which means that the OLD password will
        # persist. Since this script deletes and re-installs under the same name
        # every time, it must necessarily have a deterministic password.
        # See this GitHub issue: https://github.com/bitnami/charts/issues/9083
      - name: Create MySQL Secret
        run: |
          kubectl create secret generic mysql-db-${{ matrix.dmd }} \
            --from-literal=mysql-root-password=asdf_${{ matrix.dmd }} \
            --from-literal=mysql-replication-password=asdf_${{ matrix.dmd }} \
            --from-literal=mysql-password=asdf_${{ matrix.dmd }} \
            --namespace=${{ env.NAMESPACE }}
      - name: Create Meerkat Database Secret
        run: |
          kubectl create secret generic meerkat-${{ matrix.dmd }}-db \
            --from-literal=databaseUrl=mysql://root:asdf_${{ matrix.dmd }}@meerkat-db-${{ matrix.dmd }}-mysql.${{ env.NAMESPACE }}.svc.cluster.local:3306/directory \
            --namespace=${{ env.NAMESPACE }}
      - name: Create Temp Folder
        run: mkdir -p ./tmp
      - name: Create Certificate Authority Config
        run: echo "${{ env.CA_CONFIG }}" > openssl.conf
      - name: Create Certificate Authority Certificate
        run: echo "${{ env.CA_CERT }}" > ca.crt
      - name: Create Certificate Authority Private Key
        run: echo "${{ secrets.CA_PRIVATE_KEY }}" > ca.key
      - name: Setup Certificate Authority Files
        run: |
          mkdir ca.db.certs \
          && mkdir ca.db.index \
          && echo $((1000 + RANDOM % 9999)) > ca.db.serial
      - name: Create DSA's CSR
        run: |
          openssl req \
            -new \
            -newkey rsa:1024 \
            -nodes \
            -subj "/CN=dsa01.${{ matrix.dmd }}.${{ env.ZONE }}" \
            -keyout ./tmp/${{ matrix.dmd }}.key \
            -out ./tmp/${{ matrix.dmd }}.csr
      - name: Create DSA's Keypair
        run: |
          openssl ca \
            -config openssl.conf \
            -out ./tmp/${{ matrix.dmd }}.crt \
            -subj "/CN=dsa01.${{ matrix.dmd }}.${{ env.ZONE }}" \
            -infiles ./tmp/${{ matrix.dmd }}.csr \
            -addext "subjectAltName=DNS:dsa01.${{ matrix.dmd }}.${{ env.ZONE }}"
      - name: Create Meerkat Signing Secret
        run: |
          kubectl create secret tls meerkat-${{ matrix.dmd }}-signing \
            --cert=./tmp/${{ matrix.dmd }}.crt \
            --key=./tmp/${{ matrix.dmd }}.key \
            --namespace=${{ env.NAMESPACE }}
      - name: Create Meerkat TLS Secret
        run: |
          kubectl create secret tls meerkat-${{ matrix.dmd }}-tls \
            --cert=./tmp/${{ matrix.dmd }}.crt \
            --key=./tmp/${{ matrix.dmd }}.key \
            --namespace=${{ env.NAMESPACE }}
      - name: Add Bitnami Helm Repo
        run: helm repo add bitnami https://charts.bitnami.com/bitnami
      - name: Add Wildboar Helm Repo
        run: helm repo add ${{ env.CHART_REPO }} https://${{ env.STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/${{ env.CHART_CONTAINER }}
      - name: Update Helm Repo Index
        run: helm repo update
      - name: Install MySQL
        run: |
          helm install meerkat-db-${{ matrix.dmd }} bitnami/mysql \
            --set auth.existingSecret=mysql-db-${{ matrix.dmd }} \
            --set auth.database=directory \
            --atomic \
            --namespace=${{ env.NAMESPACE }}
      - name: Deploy Meerkat DSA via Helm
        run: |
          helm install meerkat-dsa-${{ matrix.dmd }} ${{ env.CHART_REPO }}/${{ env.CHART_NAME }} \
            --set fullnameOverride=meerkat-${{ matrix.dmd }} \
            --set service.type=LoadBalancer \
            --set adminService.type=LoadBalancer \
            --set log.level=debug \
            --set "myAccessPointNSAPs={idm://dsa01.${{ matrix.dmd }}.${{ env.ZONE }}:4632,ldap://dsa01.${{ matrix.dmd }}.${{ env.ZONE }}:389}" \
            --set chaining.minAuthLevel=0 \
            --set chaining.minAuthLocalQualifier=0 \
            --set chaining.tlsOptional=true \
            --set chaining.prohibited=false \
            --set ob.minAuthLevel=0 \
            --set ob.minAuthLocalQualifier=0 \
            --set ob.autoAccept=true \
            --set databaseReset=true \
            --set dangerouslyExposeWebAdmin=true \
            --set databaseSecretName=meerkat-${{ matrix.dmd }}-db \
            --set signingSecretName=meerkat-${{ matrix.dmd }}-signing \
            --set tlsSecretName=meerkat-${{ matrix.dmd }}-tls \
            --set tlsCaConfigName=${{ env.DEMO_TRUST_ANCHOR_CONFIG_NAME }} \
            --atomic \
            --namespace=${{ env.NAMESPACE }}
      - name: Wait 30 Seconds for Public IP to be Allocated
        run: sleep 30
      - name: Save Directory Service IP Address
        run: |
          echo 'DIRECTORY_SERVICE_IP=$(kubectl get svc -n ${{ env.NAMESPACE }} meerkat-${{ matrix.dmd }}-directory --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")' >> $GITHUB_ENV
      - name: Save Web Admin Service IP Address
        run: |
          echo 'WEB_ADMIN_SERVICE_IP=$(kubectl get svc -n ${{ env.NAMESPACE }} meerkat-${{ matrix.dmd }}-web-admin --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")' >> $GITHUB_ENV
      - name: Create DSA DNS Record
        run: |
          az network dns record-set a add-record \
            --resource-group ${{ env.DNS_RESOURCE_GROUP }} \
            --zone-name ${{ env.ZONE }} \
            --ttl 60 \
            --record-set-name dsa01.${{ matrix.dmd }} \
            --ipv4-address ${{ env.DIRECTORY_SERVICE_IP }}
      - name: Create WebAdmin DNS Record
        run: |
          az network dns record-set a add-record \
            --resource-group ${{ env.DNS_RESOURCE_GROUP }} \
            --zone-name ${{ env.ZONE }} \
            --ttl 60 \
            --record-set-name webadm01.${{ matrix.dmd }} \
            --ipv4-address ${{ env.WEB_ADMIN_SERVICE_IP }}

  seed_demo:
    name: Seed Demo Data
    runs-on: ubuntu-latest
    needs:
      - deploy_demo
    environment: production
    strategy:
      fail-fast: false
      matrix:
        dmd:
          - 'root'
          # TODO: Re-enable gb once you fix the bugs stopping this from working.
          # - 'gb'
          # - 'ru'
          # - 'ru-moscow'
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '17'
      - name: Install NPM Packages
        run: npm ci
      - name: Compile the Test DIT Creator
        run: npx nx run create-test-dit:build:production --skip-nx-cache
      - name: Run the Test DIT Creator
        run: |
          node ./dist/apps/create-test-dit/main.js \
            --accessPoint="idm://dsa01.${{ matrix.dmd }}.${{ env.ZONE }}:4632" \
            --profile=${{ matrix.dmd }} \
            -t

  functional_testing:
    name: Functional Testing
    runs-on: ubuntu-latest
    needs:
      - deploy_test
    environment: production
    env:
      MEERKAT_TEST_HOST: dsa01.test.mkdemo.wildboar.software
      MEERKAT_TEST_PORT: "4632"
      MEERKAT_TEST_LDAP_PORT: "389"
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '17'
      - name: Install NPM Packages
        run: npm ci
      - name: Run the functional tests
        run: npx nx run x500-functional-tests:test --skip-nx-cache
        timeout-minutes: 10

  # Pretty much copied from here: https://docusaurus.io/docs/deployment#deploying-to-github-pages
  deploy_docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install NPM Packages
        run: npm ci
      - name: Compile Documentation
        run: npx nx run meerkat-docs:build --skip-nx-cache

      # Popular action to deploy to GitHub Pages:
      # Docs: https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-docusaurus
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Build output to publish to the `gh-pages` branch:
          publish_dir: ./dist/apps/meerkat-docs
          # The following lines assign commit authorship to the official
          # GH-Actions bot for deploys to `gh-pages` branch:
          # https://github.com/actions/checkout/issues/13#issuecomment-724415212
          # The GH actions bot is used by default if you didn't specify the two fields.
          # You can swap them out with your own user credentials.
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com

# TODO: Publish GitHub Release
# TODO: Publish X.500 CLI
# TODO: Send Email to Subscribers?
# TODO: Publish message to Matrix chat? (Looks unclear how to do this.)
# TODO: Create a Debian Package
# TODO: Upload artifacts
