pkgname=meerkat-dsa
pkgver=4.0.0
pkgrel=0
pkgdesc="Meerkat X.500 Directory System Agent (DSA) / LDAP Server"
url="https://github.com/Wildboar-Software/directory"
maintainer="Jonathan M. Wilbur <jonathan@wilbur.space>"
arch="all"
license="MIT"
depends="nodejs npm dotenv"
install="meerkat-dsa.post-install"
subpackages="
    $pkgname-doc
    $pkgname-openrc
"
options="net" # Needed because of NPM module installation
source="/$pkgname-$pkgver.tar.gz"

build() {
	npm ci --no-audit --no-fund --no-save
	npx nx \
        --tuiAutoExit=true \
        --outputStyle=static \
        run meerkat:build \
        --skipNxCache \
        --skipRemoteCache \
        --skip-nx-cache \
        --verbose
    cd dist/apps/meerkat
    npm ci --omit=dev --no-audit --no-fund --no-save
	npm install --no-package-lock --no-fund --no-audit --no-save prisma@7.0.1
}

# FIXME: Add man pages
package() {
    mkdir -p "$pkgdir/etc"
    mkdir -p "$pkgdir/usr/lib"
    mkdir -p "$pkgdir/usr/bin"
    mkdir -p "$pkgdir/var/log"
    mkdir -p "$pkgdir/var/lib"
    install -d -m755 "$pkgdir/etc/meerkat"
    install -d -m755 "$pkgdir/usr/lib/meerkat"
    install -d -m755 "$pkgdir/var/log/meerkat"
    install -d -m755 "$pkgdir/var/lib/meerkat"
    cp -a "$builddir/dist/apps/meerkat" "$pkgdir/usr/lib"
    install -m 0644 \
        "$builddir/dist/apps/meerkat/prisma/prisma.config.ts" \
        "$pkgdir/usr/lib/meerkat"
    install -m 0644 "$builddir/pkg/meerkat.env" "$pkgdir/etc/meerkat"
    install -m 0755 "$builddir/pkg/meerkat" "$pkgdir/usr/bin"
    install -Dm755 \
        "$builddir/pkg/apk/initd/meerkat" \
        "$pkgdir/etc/init.d/meerkat"

}

check() {
    # default_check
    npx nx \
        --tuiAutoExit=true \
        --outputStyle=static \
        run-many \
        --target=test \
        --all \
        --skipNxCache \
        --skipRemoteCache \
        --skip-nx-cache \
        --verbose \
        --exclude x500-functional-tests
    # TODO: Could you run the integration tests here?
}

openrc() {
    pkgdesc="$pkgdesc (OpenRC init scripts)"
    install -Dm755 \
        "$builddir/pkg/apk/initd/meerkat" \
        "$subpkgdir/etc/init.d/meerkat"
}

doc() {
    pkgdesc="$pkgdesc (documentation)"
    install -d -m755 "$pkgdir/usr/share/man/man1"
    install -d -m755 "$pkgdir/usr/share/man/man5"
    install -m 0644 \
        "$builddir/doc/man/man1/meerkat-dsa.1" \
        "$pkgdir/usr/share/man/man1"
    install -m 0644 \
        "$builddir/doc/man/man5/meerkat.env.5" \
        "$pkgdir/usr/share/man/man5"
    gzip -9 "$subpkgdir/usr/share/man/man1/meerkat-dsa.1"
    gzip -9 "$subpkgdir/usr/share/man/man5/meerkat.env.5"
}
